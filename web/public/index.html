<html>
<script src="/socket.io/socket.io.js"> </script>
<script>
   
</script>

<link href="css/nv.d3.css" rel="stylesheet" type="text/css">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="/js/nv.d3.min.js"></script>


<body>
  <div>
    <div id='chart1'>
      <svg style='height:400px'/>
    </div>
    <div id='chart2'>
      <svg style='height:400px'/>
    </div>
</div>

<script>
    var socketAddr = window.location.protocol + "//" + window.location.host
    var socket = io.connect(socketAddr);
    socket.on('connect', function(data){
    });
      
    
    
    var chartBuffer = 0.10
    var maxLength = 200
    var data1 = []
    var data2 = []
    var data3 = []
    socket.on('dataUpdate', function(data){
      var date = new Date(data.date);
      
      data1.push({x: date, y: data.temp1})
      data2.push({x: date, y: data.temp2})
      data3.push({x: date, y: data.light})
      if (data1.length > maxLength)
        data1.shift()
      if (data2.length > maxLength)
        data2.shift()
      if (data3.length > maxLength)
        data3.shift()
        
      var d1minMax = findMinMax(data1)
      var d2minMax = findMinMax(data2)
      var d3minMax = findMinMax(data3)
      var y1min = Math.min(d1minMax.min, d2minMax.min)
      var y1max = Math.max(d1minMax.max, d2minMax.max)
      var y1buffer = (y1max - y1min) * chartBuffer
      y1min = y1min - y1buffer
      y1max = y1max + y1buffer
      var y2buffer = (d3minMax.max - d3minMax.min) * chartBuffer
      var y2min = d3minMax.min - y2buffer
      var y2max = d3minMax.max + y2buffer
        
        redraw([{
          values: data1,
          key: "Temp 1",
          yAxis: 1,
          type: "line"
        },{
          values: data2,
          key: "Temp 2",
          yAxis: 1,
          type: "line"
        },{
          values: data3,
          key: "Light",
          yAxis: 2,
          type: "line"
        }], {min: y1min, max: y1max},{min: y2min, max: y2max})
    });
    
    
    var chart;
    
    nv.addGraph(function() {  
//      chart = nv.models.lineChart();
      chart = nv.models.multiChart();
 
      chart.xAxis
        .axisLabel('Date')
        .tickFormat(function(d) {
          return d3.time.format('%H:%M')(new Date(d));
        });
 
      chart.yAxis1
        .axisLabel('Temperature')
        .tickFormat(d3.format(',r'));
        
      chart.yAxis2
        .axisLabel("Light")
        .tickFormat(d3.format(',r'));
          
      chart.yDomain1([40,100])
      chart.yDomain2([120, 1000])
          
      chart.options({
        showControls: true,
        showLegend: true
      })
          // chart.interpolate('step-before ')

 
      d3.select('#chart1 svg')
        .datum([])
        .transition().duration(500)
        .call(chart);

 
      nv.utils.windowResize(function() { d3.select('#chart1 svg').call(chart) });

      return chart;
    });
 
 
    function redraw(datum, y1minMax, y2minMax) {
      chart.yDomain1([y1minMax.min, y1minMax.max])
      chart.yDomain2([y2minMax.min, y2minMax.max])
      
      d3.select('#chart1 svg')
        .datum(datum)
        .transition().duration(50)
        .call(chart);
    }
    
    function findMinMax(dataPoints) {
      var min = Number.MAX_VALUE;
      var max = Number.MIN_VALUE;
      dataPoints.forEach(function(elem){
        min = Math.min(elem.y, min)
        max = Math.max(elem.y, max)
      })
      
      return {
        min: min,
        max: max
      }
    }
  </script>
</body>
</html>